> 题目序号：（2106）
>
> 题目来源：腾讯
>
> 频次：1

## 答案：郭健

线上性能问题的定位和优化是程序员进阶的必经之路，定位问题的方式有多种多样，常见的有观察线程栈、排查日志和做性能分析。性能分析（profile）作为定位性能问题的大杀器，它可以收集程序执行过程中的具体事件，并且对程序进行抽样统计，从而能更精准的定位问题。本文会以 go 语言的 pprof 工具为例，分享两个线上性能故障排查过程，希望能通过本文使大家对性能分析有更深入的理解。

**1.OS诊断**
系统诊断，我们一般主要关注三个方面: CPU 、Memory、I/O
**1.1 CPU**
CPU诊断主要关注平均负载（Load Average），CPU使用率，上下文切换（Context Switch）。常用top命令查看cpu使用率以及服务器负载情况。

![avatar](https://image-1302243118.cos.ap-beijing.myqcloud.com/img/v2-7a271d6ff9eafee15b221760d550f57d_1440w.png)

平均负载:0.14 0.07 0.06 分别表示过去1分钟、5分钟、15分钟的机器负载的平均值，根据经验，若负载数值小于0.7*CPU个数则正常，超过或者达到CPU核数的四五倍，则系统的负载就明显偏高。

CPU的上下文切换情况可通过vmstat命令可以查看，上下文切换发生的场景有如下几种:

1. 时间片用完，CPU正常调度下一个任务
2. 被其他优先级更高的任务抢占
3. 执行任务碰到I/O阻塞，挂起当前任务，切换到下一个任务
4. 用户代码主动挂起当前任务让出CPU
5. 多任务抢占资源，因没抢到而被挂起
6. 硬件中断

**1.2 Memory**

从操作系统角度，内存关注应用进程是否足够，可以使用 free –m 命令查看内存的使用情况。

通过 top 命令可以查看进程使用的虚拟内存 VIRT 和物理内存 RES，根据公式 VIRT = SWAP + RES 可以推算出具体应用使用的交换分区（Swap）情况，使用交换分区过大会影响 应用性能，可以将 swappiness 值调到尽可能小

**1.3 I/O**
I/O 包括磁盘 I/O 和网络 I/O，一般情况下磁盘更容易出现 I/O 瓶颈。通过iostat可以查看磁盘的读写情况，通过 CPU 的 I/O wait 可以看出磁盘 I/O 是否正常。

如果磁盘 I/O 一直处于很高的状态，说明磁盘太慢或故障，成为了性能瓶颈，需要进行应用优化或者磁盘更换。

除了常用的 top、 ps、vmstat、iostat 等命令，还有其他 Linux 工具可以诊断系统问题，如 mpstat、tcpdump、netstat、pidstat、sar 等 更多Linux性能诊断工具如下图：

![avatar](https://image-1302243118.cos.ap-beijing.myqcloud.com/img/v2-5d339841805910223f55021f0a7992be_1440w.jpg)

**2.GO应用诊断**

go生态已经为我们提供了大量的API和诊断工具帮助我们解决go应用的性能问题。我们常用的大致可以分为两类:

1. Profiling 收集程序执行过程中的具体事件，并抽样统计 方便精确定位问题
2. Tracing 一种检测代码的方法，用于分析调用或用户请求整个生命周期中的延迟，且可以跨多个Go进程。